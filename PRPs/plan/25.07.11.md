## 分销项目
### todolist
[X] 创建 common 模块（通⽤响应、异常封装、枚举定义）
[X] 实现 JWT ⼯具类 + 拦截器
[ ] RBAC 权限注解封装 + 上下⽂⼯具类
[ ] 接⼊ Swagger ⽂档并⽣成测试⻚⾯

### 项目进展
[X] 完成 users、agent_levels、user_agent_level 等核⼼表设计
[X] 建⽴ ER 图（可使⽤ db-diagram.io）
[X] 编写建表 SQL 脚本并验证建库成功
[X] 编写 Redis 缓存初始化脚本

### 今日完成任务详情 (2025.07.11)

#### 任务一：创建 common 模块（通用响应、异常封装、枚举定义）✅
**完成文件：**
1. **ApiResponse.java** - 统一API响应格式
   - 包含 code、message、data 三个核心字段
   - 提供静态方法：success()、error() 等便捷创建方法
   - 支持泛型，灵活处理不同数据类型

2. **BusinessException.java** - 业务异常类
   - 继承RuntimeException，支持自定义错误码和错误信息
   - 提供多种构造方法，便于不同场景使用

3. **GlobalExceptionHandler.java** - 全局异常处理器
   - 使用@RestControllerAdvice注解，统一处理系统异常
   - 捕获BusinessException和通用Exception
   - 返回标准化的ApiResponse格式

4. **枚举类定义：**
   - **UserRole.java** - 用户角色枚举（超级管理员、总监、组长、销售、代理）
   - **UserStatus.java** - 用户状态枚举（活跃、禁用）
   - **LeadStatus.java** - 客户状态枚举（新提交、已联系、有意向、已成交、无效）
   - **PromotionPlatform.java** - 推广平台枚举（抖音、小红书、快手）
   - **PromotionType.java** - 推广类型枚举（图文、视频、真人出镜）

5. **常量类：**
   - **ApiConstants.java** - API相关常量（状态码、消息等）
   - **RedisKeys.java** - Redis键值常量及生成方法

6. **工具类：**
   - **ValidationUtils.java** - 数据验证工具（手机号、邮箱格式验证）

7. **pom.xml配置** - 添加Spring Boot Web、Validation、Jackson等必要依赖

#### 任务二：实现 JWT 工具类 + 拦截器 ✅
**完成文件：**
1. **JwtUtils.java** - JWT工具类
   - generateToken() - 生成JWT令牌，包含userId和role信息
   - parseToken() - 解析JWT令牌获取Claims
   - getUserIdFromToken() - 从令牌中提取用户ID
   - getRoleFromToken() - 从令牌中提取用户角色
   - validateToken() - 验证令牌有效性
   - isTokenExpired() - 检查令牌是否过期
   - 使用HMAC SHA256算法签名，24小时有效期

2. **UserContextHolder.java** - 用户上下文管理
   - 使用ThreadLocal存储当前请求的用户信息
   - 提供UserContext内部类封装userId和role
   - getCurrentUserId()、getCurrentUserRole() - 便捷获取当前用户信息
   - clear() - 清理线程本地变量，防止内存泄漏

3. **JwtInterceptor.java** - JWT拦截器
   - 实现HandlerInterceptor接口
   - preHandle() - 请求前验证Authorization头中的Bearer token
   - 验证成功后将用户信息存入UserContextHolder
   - afterCompletion() - 请求完成后清理上下文
   - 验证失败返回401状态码

4. **依赖更新：**
   - 添加jjwt相关依赖（api、impl、jackson）
   - 添加javax.servlet-api依赖

**技术特点：**
- 无状态JWT认证，支持分布式部署
- 线程安全的用户上下文管理
- 统一的拦截器处理，无需在每个接口重复验证
- 标准的HTTP Authorization头格式
- 完整的令牌生命周期管理

---

## Git提交总览

### Commit 1: feat(common): 创建common模块基础架构
**提交说明：** 建立分销系统通用模块，包含响应格式、异常处理、枚举定义

**文件变更清单：**
```
common/pom.xml                                          [新建] Maven配置文件
common/src/main/java/com/example/common/
├── dto/
│   └── ApiResponse.java                                [新建] 统一API响应格式
├── exception/
│   ├── BusinessException.java                         [新建] 业务异常类
│   └── GlobalExceptionHandler.java                    [新建] 全局异常处理器
├── enums/
│   ├── UserRole.java                                  [新建] 用户角色枚举
│   ├── UserStatus.java                                [新建] 用户状态枚举
│   ├── LeadStatus.java                                [新建] 客户状态枚举
│   ├── PromotionPlatform.java                         [新建] 推广平台枚举
│   └── PromotionType.java                             [新建] 推广类型枚举
├── constants/
│   ├── ApiConstants.java                              [新建] API常量定义
│   └── RedisKeys.java                                 [新建] Redis键值常量
└── utils/
    └── ValidationUtils.java                           [新建] 数据验证工具类
```

**功能特性：**
- ✅ 统一API响应格式，支持泛型和便捷方法
- ✅ 完善的异常处理机制，区分业务异常和系统异常
- ✅ 全面的枚举定义，覆盖用户、客户、推广等核心业务
- ✅ 标准化常量管理，便于维护和扩展
- ✅ 基础工具类，提供数据验证功能

**影响范围：** 新建模块，无破坏性变更
**测试状态：** 基础架构，待集成测试

---

### Commit 2: feat(common): 实现JWT认证体系和用户上下文管理
**提交说明：** 添加JWT工具类、拦截器和线程安全的用户上下文管理

**文件变更清单：**
```
common/pom.xml                                          [修改] 添加JWT相关依赖
common/src/main/java/com/example/common/
├── utils/
│   ├── JwtUtils.java                                   [新建] JWT工具类
│   └── UserContextHolder.java                         [新建] 用户上下文管理
└── interceptor/
    └── JwtInterceptor.java                             [新建] JWT请求拦截器
```

**新增依赖：**
```xml
<!-- JWT相关 -->
io.jsonwebtoken:jjwt-api:0.11.5
io.jsonwebtoken:jjwt-impl:0.11.5
io.jsonwebtoken:jjwt-jackson:0.11.5

<!-- Servlet API -->
javax.servlet:javax.servlet-api (provided)
```

**核心功能：**
- ✅ JWT令牌生成与解析 (24小时有效期)
- ✅ 用户身份验证与角色提取
- ✅ 线程安全的用户上下文存储
- ✅ HTTP请求统一拦截验证
- ✅ 标准Bearer Token格式支持

**API接口：**
```java
// JWT工具类
JwtUtils.generateToken(userId, role)     → 生成令牌
JwtUtils.validateToken(token)            → 验证令牌
JwtUtils.getUserIdFromToken(token)       → 提取用户ID
JwtUtils.getRoleFromToken(token)         → 提取用户角色

// 用户上下文
UserContextHolder.getCurrentUserId()     → 获取当前用户ID
UserContextHolder.getCurrentUserRole()   → 获取当前用户角色
```

**安全特性：**
- HMAC SHA256算法签名
- 自动令牌过期检查
- 线程隔离的用户信息存储
- 请求结束后自动清理上下文

**影响范围：** common模块扩展，向后兼容
**测试状态：** 核心功能完成，待集成验证

---

## 下一步计划

### 任务三：RBAC权限注解封装 + 上下文工具类
**预期功能：**
- 创建权限控制注解 (@RequireRole, @RequirePermission)
- 实现AOP切面进行权限检查
- 扩展用户上下文，支持权限信息
- 提供权限验证工具类

### 任务四：接入Swagger文档并生成测试页面
**预期功能：**
- 配置Swagger/OpenAPI文档
- 自动生成API接口文档
- 创建在线测试页面
- 集成JWT认证到Swagger UI



