<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.promotion.mapper.PromotionMapper">
    
    <!-- 结果映射 -->
    <resultMap id="PromotionResultMap" type="com.example.promotion.entity.Promotion">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="description" property="description"/>
        <result column="platform" property="platform"/>
        <result column="type" property="type"/>
        <result column="status" property="status"/>
        <result column="audit_status" property="auditStatus"/>
        <result column="creator_id" property="creatorId"/>
        <result column="creator_name" property="creatorName"/>
        <result column="auditor_id" property="auditorId"/>
        <result column="auditor_name" property="auditorName"/>
        <result column="audit_comment" property="auditComment"/>
        <result column="reject_reason" property="rejectReason"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="audited_at" property="auditedAt"/>
    </resultMap>
    
    <!-- 基础字段 -->
    <sql id="BaseColumns">
        id, title, description, platform, type, status, audit_status,
        creator_id, creator_name, auditor_id, auditor_name, 
        audit_comment, reject_reason, created_at, updated_at, audited_at
    </sql>
    
    <!-- 插入推广任务 -->
    <insert id="insert" parameterType="com.example.promotion.entity.Promotion" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO promotions (
            title, description, platform, type, status, audit_status,
            creator_id, creator_name, created_at, updated_at
        ) VALUES (
            #{title}, #{description}, #{platform}, #{type}, #{status}, #{auditStatus},
            #{creatorId}, #{creatorName}, #{createdAt}, #{updatedAt}
        )
    </insert>
    
    <!-- 根据ID查询 -->
    <select id="selectById" parameterType="long" resultMap="PromotionResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM promotions
        WHERE id = #{id}
    </select>
    
    <!-- 分页查询推广任务列表 -->
    <select id="selectPromotions" resultMap="PromotionResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM promotions
        <where>
            <if test="creatorId != null">
                AND creator_id = #{creatorId}
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="auditStatus != null and auditStatus != ''">
                AND audit_status = #{auditStatus}
            </if>
        </where>
        ORDER BY created_at DESC
        LIMIT #{offset}, #{size}
    </select>
    
    <!-- 统计推广任务数量 -->
    <select id="countPromotions" resultType="int">
        SELECT COUNT(*)
        FROM promotions
        <where>
            <if test="creatorId != null">
                AND creator_id = #{creatorId}
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="auditStatus != null and auditStatus != ''">
                AND audit_status = #{auditStatus}
            </if>
        </where>
    </select>
    
    <!-- 更新推广任务 -->
    <update id="update" parameterType="com.example.promotion.entity.Promotion">
        UPDATE promotions
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="description != null">description = #{description},</if>
            <if test="platform != null">platform = #{platform},</if>
            <if test="type != null">type = #{type},</if>
            <if test="status != null">status = #{status},</if>
            <if test="auditStatus != null">audit_status = #{auditStatus},</if>
            <if test="auditorId != null">auditor_id = #{auditorId},</if>
            <if test="auditorName != null">auditor_name = #{auditorName},</if>
            <if test="auditComment != null">audit_comment = #{auditComment},</if>
            <if test="rejectReason != null">reject_reason = #{rejectReason},</if>
            <if test="auditedAt != null">audited_at = #{auditedAt},</if>
            updated_at = #{updatedAt}
        </set>
        WHERE id = #{id}
    </update>
    
    <!-- 删除推广任务 -->
    <delete id="deleteById" parameterType="long">
        DELETE FROM promotions WHERE id = #{id}
    </delete>
    
    <!-- 批量更新审核状态 -->
    <update id="batchUpdateAuditStatus">
        UPDATE promotions
        SET audit_status = #{auditStatus},
            auditor_id = #{auditorId},
            auditor_name = #{auditorName},
            audited_at = NOW(),
            updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
    
    <!-- 根据创建者ID查询 -->
    <select id="selectByCreatorId" parameterType="long" resultMap="PromotionResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM promotions
        WHERE creator_id = #{creatorId}
        ORDER BY created_at DESC
    </select>
    
    <!-- 根据审核状态查询 -->
    <select id="selectByAuditStatus" parameterType="string" resultMap="PromotionResultMap">
        SELECT <include refid="BaseColumns"/>
        FROM promotions
        WHERE audit_status = #{auditStatus}
        ORDER BY created_at DESC
    </select>
    
</mapper>